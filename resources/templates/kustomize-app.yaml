apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kustomize-app
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  labels:
    name: kustomize-app
spec:
  project: default
  
  source:
    repoURL: https://github.com/argoproj/argocd-example-apps.git
    targetRevision: HEAD
    path: kustomize-guestbook
    
    kustomize:
      version: v3.5.4
      namePrefix: prod-
      nameSuffix: -some-suffix
      commonLabels:
        foo: bar
      commonAnnotations:
        beep: boop-${ARGOCD_APP_REVISION}
      commonAnnotationsEnvsubst: true
      labelWithoutSelector: false
      labelIncludeTemplates: false
      forceCommonLabels: false
      forceCommonAnnotations: false
      images:
      - quay.io/argoprojlabs/argocd-e2e-container:0.2
      - my-app=gcr.io/my-repo/my-app:0.1
      namespace: default
      replicas:
      - name: kustomize-guestbook-ui
        count: 4
      components:
        - ../component
      ignoreMissingComponents: false
      patches:
        - target:
            kind: Deployment
            name: guestbook-ui
          patch: |-
            - op: add
              path: /spec/template/spec/nodeSelector/
              value:
                env: "pro"
      kubeVersion: 1.30.0
      apiVersions:
        - traefik.io/v1alpha1/TLSOption
        - v1/Service
  
  destination:
    server: https://kubernetes.default.svc
    namespace: default
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false
    syncOptions:
    - Validate=true
    - CreateNamespace=true
    - PrunePropagationPolicy=foreground
    - PruneLast=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
